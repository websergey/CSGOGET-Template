"use strict";window.app=window.app||{};app.domain=(function(){var arr=location.hostname.split('.');return arr[arr.length-1];})();app.locale=app.domain==='ru'?'ru':'en';app.poly=new Polyglot({phrases:i18n[app.locale]});app.poly.l=app.locale;$('title').text(app.poly.t('CSGO-EASY.RU - первый игровой онлайн розыгрыш'));var sio={backendNum:Math.round(Math.random()),socket:null,init:function init(){var self=this;self.socket=io.connect(app.backends[self.backendNum]);self.socket.once('connect',function(){self.connected(self.socket,self.backendNum);});self.socket.once('connect_error',function(){self.backendNum=self.backendNum===0?1:0;self.socket.destroy();self.socket=io.connect(app.backends[self.backendNum]);self.socket.once('connect',function(){self.connected(self.socket,self.backendNum);});self.socket.once('connect_error',function(){self.trigger('failed',{});});});},connected:function connected(socket,num){if(app.debug)console.log('Connected to backend #'+(num+1));app.curBackend=app.backends[num];this.trigger('connected',socket);}}
_.extend(sio,Backbone.Events);sio.init();sio.once('connected',function(socket){app.socket=socket;$(function(){if(app.debug)console.log('Dom ready, app started!');app.start(socket);});});sio.once('failed',function(){alert(app.poly.t('Нет соединения с сервером! Возможно ведутся технические работы. Попробуйте зайти ещё раз позже.'));});app.start=function(socket){var authModel=new app.AuthModel();var lastWinnerModel=new app.LastWinnerModel();var gameStatsModel=new app.GameStatsModel();var gameModel=new app.GameModel();var itemsModel=new app.ItemsModel();var historyModel=new app.HistoryModel();var ladderModel=new app.LadderModel();var onlineModel=new app.OnlineModel();var headerView=new app.HeaderView({authModel:authModel,gameStatsModel:gameStatsModel})
var sidebarView=new app.SidebarView({authModel:authModel,lastWinnerModel:lastWinnerModel,onlineModel:onlineModel});var router=new app.Router({authModel:authModel,gameStatsModel:gameStatsModel,lastWinnerModel:lastWinnerModel,gameModel:gameModel,itemsModel:itemsModel,historyModel:historyModel,ladderModel:ladderModel});var historyStart=_.once(function(){Backbone.history.start();});socket.on('init',function(data){if(app.debug)console.dir(data);itemsModel.set({items:data['state']['game']['itemsArr']});delete data['state']['game']['itemsArr'];data['state']['game']['serverTime']=data['state']['serverTime'];gameModel.set(data['state']['game']);authModel.set(data['auth']);lastWinnerModel.set(data['state']['lastWinner']);gameStatsModel.set(data['state']['stats']);onlineModel.set({online:parseInt(data['state']['con'])});historyStart();});socket.on('update-game',function(data){itemsModel.set({items:data['game']['itemsArr']});lastWinnerModel.set(data['lastWinner']);gameStatsModel.set(data['stats']);delete data['game']['itemsArr'];data['game']['serverTime']=data['serverTime'];data['game']['lastUpdated']=_.now();gameModel.set(data['game']);onlineModel.set({online:parseInt(data['con'])});if(app.debug)console.dir(data);});socket.on('update-ui-state',function(data){authModel.set(data);});socket.on('msg',function(msg){var msgText=''
if(msg.type!=null){msgText=app.locale==='ru'?msg.msg:msg.msgEn;}else{msgText=app.poly.t(msg.msg);msg.type=msg.msgEn;}
noty({text:'<div><strong>'+ app.poly.t(msg.title)+'</strong><br/>'+ msgText+'</div>',layout:'topRight',type:msg.type,theme:'relax',timeout:8000,closeWith:['click'],animation:{open:'animated bounceInRight',close:'animated bounceOutRight'}});});socket.on('history-response',function(games){historyModel.set({games:games});});socket.on('ladder-response',function(top){ladderModel.set(top);});$('.content-main-inner').on('click','.form-get-link .save-link',function(){socket.emit('token-link',{link:$('.form-get-link input[name=link]').val()});});app.sound=new SoundBlasterFata1ty();gameModel.once('change',function(){gameModel.on('change:number',function(){app.sound.gameStart();});itemsModel.on('change',function(){_.delay(function(){app.sound.bet();},55);});});};