"use strict";window.app=window.app||{};app.HeaderView=Backbone.View.extend({el:'header.header',initialize:function initialize(options){this.authModel=options.authModel;this.gameStatsModel=options.gameStatsModel;this.template=_.template($('#header').html());this.authModel.on('change:auth',function(){this.render();},this);},render:function render(){var html=this.template({auth:this.authModel.get('auth'),jackpot:this.gameStatsModel.get('jackpot'),poly:app.poly,link:app.domain==='com'?app.curBackend+'authCom':app.curBackend+'auth'});this.$el.html(html);this.$jackpot=this.$('.jackpotNum');this.gameStatsModel.on('change:jackpot',function(num){this.$jackpot.text(this.gameStatsModel.formatSum('jackpot'));},this);}});app.SidebarView=Backbone.View.extend({el:'aside.sidebar-left',authModel:null,lastWinnerModel:null,initialize:function initialize(options){if(app.debug)console.log('sidebar init');this.authModel=options.authModel;this.lastWinnerModel=options.lastWinnerModel;this.onlineModel=options.onlineModel;this.template=_.template($('#sidebar').html());this.lastWinnerModel.on('change',function(){if(app.debug)console.log('sidebar lastWinnerModel change');this.render();},this);this.listenToOnce(this.onlineModel,'change',this.setOnline,this);},render:function render(){if(app.debug)console.log('sidebar render call');var html=this.template({lastWinner:this.lastWinnerModel.toJSON(),auth:this.authModel.toJSON(),poly:app.poly,filter:app.filter});this.$el.html(html);this.$online=this.$('.online-num');return this;},setOnline:function setOnline(){this.$online.text(this.onlineModel.get('online')*3+ Math.round(7*Math.random()));_.delay(function(self){self.setOnline();},2000,this)}});app.MainPageView=Backbone.View.extend({el:'div.content-main-inner',authModel:null,gameStatsModel:null,initialize:function initialize(options){if(app.debug)console.log('mainPage init');this.authModel=options.authModel;this.gameStatsModel=options.gameStatsModel;this.template=_.template($('#mainpage').html());this.gameTopView=new app.GameTopView({gameModel:options.gameModel,authModel:options.authModel,itemsModel:options.itemsModel});if(this.authModel.auth!==null){this.render();}else{this.listenToOnce(this.authModel,'change',this.render);}},render:function render(){if(app.debug)console.log('mainPage render call');var html=this.template({auth:this.authModel.toJSON(),poly:app.poly,link:app.domain==='com'?app.curBackend+'authCom':app.curBackend+'auth'});this.$el.html(html);this.gameTopView.render();this.afterRender();return this;},afterRender:function afterRender(){this.$totalGamesPlayed=this.$('.totalGamesPlayed');this.$totalUniquePlayers=this.$('.totalUniquePlayers');this.$totalItems=this.$('.totalItems');this.$maxPayed=this.$('.maxPayed');this.$jackpotNum=this.$('.jackpotNum');this.changeStats=function changeStats(){if(app.debug)console.log('mainPage gameStatsModel change');this.$totalGamesPlayed.text(this.gameStatsModel.get('totalGamesPlayed'));this.$jackpotNum.text(this.gameStatsModel.formatSum('jackpot'));this.$totalUniquePlayers.text(this.gameStatsModel.get('totalUniquePlayers'));this.$totalItems.text(this.gameStatsModel.get('totalPayed'));this.$maxPayed.text(this.gameStatsModel.formatSum('maxPayed'));};this.listenTo(this.gameStatsModel,'change',this.changeStats);this.changeStats();this.listenToOnce(this.authModel,'change:token',function(){if(this.authModel.get('token')!=null){$('.token-block').addClass('hidden');}});},remove:function remove(){this.stopListening();if(this.gameTopView!=null){this.gameTopView.remove();}}});app.GameTopView=Backbone.View.extend({events:{'click .sound-link':'turnSound'},initialize:function initialize(options){if(app.debug)console.log('GameTopView init');this.gameModel=options.gameModel;this.authModel=options.authModel;this.itemsModel=options.itemsModel;this.template=_.template($('#game-table').html());},render:function render(){this.setElement('div.game');if(app.debug)console.log('GameTopView render call');this.$el.prepend(this.template({auth:this.authModel.get('auth'),poly:app.poly,link:app.curBackend+'trade'}));this.$activetimer=this.$('.gameactive .timer');this.$endtimer=this.$('.gameend .timer');this.$prize=this.$('.game-price-content span');this.$progressbarText=this.$('.progressbar-text span');this.$gameactive=this.$('.gameactive');this.$gameend=this.$('.gameend');this.$winnerName=this.$('.winner-left h3 span');this.$winnerPrize=this.$('.winner-cost-value');this.$gameNum=this.$('.game-num');this.$ortext=this.$('.or-text');this.$tape=this.$('.all-players-list');this.$soundSwitch=this.$('.sound-link');this.progressbar=new Progressbar(app.maxItems);this.changeGameState=function changeGameState(){var self=this;this.$gameNum.text(('000000'+ this.gameModel.get('number')).slice(-6));if(this.gameModel.get('winner')==null){this.updateActive();}else{this.updateEnd();}}
this.listenTo(this.gameModel,'change',this.changeGameState,this);this.changeGameState();this.changeClosedState=function changeClosedState(){var self=this;if(this.gameModel.get('closed')!=null){this.$activetimer.hide();this.$ortext.hide();addPlankClosed();}else{this.$activetimer.show();this.$ortext.show();}}
this.listenTo(this.gameModel,'change:closed',this.changeClosedState,this);this.changeClosedState();this.gameTableView=new app.GameTableView({authModel:this.authModel,itemsModel:this.itemsModel,gameModel:this.gameModel}).render();this.delegateEvents();},updateActive:function updateActive(){this.$gameactive.removeClass('hidden');this.$gameend.addClass('hidden');this.progressbar.set(this.gameModel.get('itemsNum'));this.$prize.text('~ $'+ this.gameModel.formatSum('prize'));if(this.gameModel.get('timeOldEnds')!=null&&this.gameModel.get('timeOldEnds')!==0){var timediff=_.now()- this.gameModel.get('lastUpdated');var timer=Math.round((this.gameModel.get('timeOldEnds')- this.gameModel.get('serverTime')- timediff)/ 1000);
this.$activetimer.empty().countdown({seconds:timer,freeze:false});}else{this.$activetimer.empty().countdown({seconds:180,freeze:true});}},updateEnd:function updateEnd(){this.$gameactive.addClass('hidden');this.$gameend.removeClass('hidden');this.$winnerName.text('???');this.$winnerPrize.text('~ '+ this.gameModel.formatSum('prize'));var timediff=_.now()- this.gameModel.get('lastUpdated');var timer=Math.round((this.gameModel.get('timeNewStarts')- this.gameModel.get('serverTime')- timediff)/ 1000);
this.$endtimer.empty().countdown({seconds:timer,freeze:false});this.gameRoulette();},gameRoulette:function gameRoulette(){var html='';_.each(this.gameModel.get('tape'),function(e){html+='<img src="'+e+'">'});this.$tape.html(html).css({transform:'translate3d(0,0,0)'});var translate=100*84- parseInt(this.$gameend.width()*0.5)- 20+ Math.round(80*parseFloat(this.gameModel.get('rand')));var transition=18;var timeNewStarts=25;var timeDiff=_.now()- this.gameModel.get('lastUpdated');var timeLeft=Math.round((this.gameModel.get('timeNewStarts')- this.gameModel.get('serverTime')- timeDiff)/ 1000) - timeNewStarts + transition;
timeLeft=timeLeft<0?0:timeLeft;var percentDone=1-(timeLeft/transition);this.$tape.css({transition:'none',transform:'translate3d(-'+ translate*percentDone+'px,0,0)','backface-visibility':'hidden'});_.delay(function(self){self.$tape.css({transition:transition*(1- percentDone)+'s ease',transform:'translate3d(-'+ translate+'px,0,0)'});var loc=10;var newLoc=0;var interval=setInterval(function(){newLoc=getTransformOffset(self.$tape);if(loc- newLoc>=74){loc=newLoc;app.sound.click();}},80);_.delay(function(){clearInterval(interval);},parseInt(((transition+ 0.5)*(1- percentDone))*1000));},100,this);_.delay(function(self){self.$winnerName.text(app.filter(self.gameModel.get('winner')));},parseInt(((transition+ 0.5)*(1- percentDone))*1000),this);function getTransformOffset($elem){var array=$elem.css('transform').split(',');if(array.length===6){return parseInt(array[4]);}else if(array.length===16){return parseInt(array[12]);}else{return 0;}}},turnSound:function turnSound(){this.$soundSwitch.toggleClass('hidden');app.sound.toggle();},remove:function remove(){this.stopListening();this.undelegateEvents();if(this.gameTableView!=null){this.gameTableView.remove();}}});app.GameTableView=Backbone.View.extend({el:'.game-content',previousNum:0,initialize:function initialize(options){if(app.debug)console.log('GameTableView init');this.itemsModel=options.itemsModel;this.gameModel=options.gameModel;this.authModel=options.authModel;this.panelTemplate=_.template($('#game-panel').html());this.$details=this.$('.details-wrap');this.$table=this.$('tbody');this.listenTo(this.itemsModel,'change',function(){if(this.authModel.get('auth')){this.renderDetails();}
this.renderLast();},this);this.listenTo(this.gameModel,'change:winner',function(){this.renderDetails();if(this.gameModel.get('winner')==null){this.renderAll();}},this);this.renderDetails();this.renderAll();},renderDetails:function renderDetails(){var self=this;if(this.gameModel.get('winner')!=null){this.$details.empty();return this;}if(this.authModel.get('auth')!==true){this.$details.empty();return this;}
var countBet=0;var countPrize=0;var countItems=0;if(self.authModel.get('userid')!=null){self.itemsModel.get('items').forEach(function(e){if(e['playerId']==self.authModel.get('userid')){countBet+=parseFloat(e['itemPrice']);countItems++;}
countPrize+=parseFloat(e['itemPrice']);});}
var chance=0;if(countBet>0){chance=parseFloat((countBet/countPrize)*100).toFixed(1)}
if(chance>99.9){chance=100;}
var html=this.panelTemplate({chance:chance,items:countItems,poly:app.poly,link:app.curBackend+'trade'});this.$details.html(html);return this;},renderAll:function renderAll(){var html='';_.each(this.itemsModel.get('items'),function(e){html=this.getItemHtml(e)+ html;},this);this.$table.html(html);this.previousNum=this.itemsModel.get('items').length;},renderLast:function renderLast(){var self=this;if(app.debug)console.log('renderLast called');function prependItem(i){setTimeout(function(){self.$table.prepend(self.getItemHtml(self.itemsModel.get('items')[i]));},80*t);}
var t=0;for(var i=this.previousNum;i<this.itemsModel.get('items').length;i++){this.previousNum++;t++;prependItem(i);};},getItemHtml:function getItemHtml(e){var self=this;var bgColor='';var fontColor='';var trClass='';if(e['rarity']!=='Ширпотреб'){trClass='item-bg';}
var rarity=e['rarity'].trim();switch(rarity){case'Армейское качество':bgColor='#3A5BFF';fontColor='#FFFFFF';break;case'Запрещенное':bgColor='rgb(135, 73, 255)';fontColor='rgb(255, 255, 255)';break;case'Засекреченное':bgColor='rgb(212, 45, 186)';fontColor='rgb(255, 255, 255)';break;case'Тайное':bgColor='rgb(227, 65, 50)';fontColor='rgb(255, 255, 255)';break;case'StatTrak™':bgColor='rgb(207, 106, 50)';fontColor='rgb(255, 255, 255)';break;case'★':case'★ StatTrak™':case'Контрабандное':bgColor='rgb(246, 228, 70)';fontColor='rgb(40, 40, 40)';break;default:bgColor='rgb(255,255,255)';fontColor='rgb(30, 150, 176)';}
var style='color: '+ fontColor+'; background-color: '+ bgColor+';';var itemName=app.locale==='ru'?e['itemName']:e['itemNameEn'];var itemsHtml='<tr class="'+ trClass+'" style="'+ style+'">'
+'<td class="col-ava"><img src="'+ e['playerImage']+'" alt="'+ e['playerId']+'" /></td>'
+'<td class="col-text"><p>'+ _.escape(app.filter(e['playerName']))+' '+ app.poly.t('вложил')+' <span>'+ itemName+'</span> (~$'+ parseFloat(parseFloat(e['itemPrice']).toFixed(2))+')</p></td>'
+'<td class="col-img"><img src="http://steamcommunity-a.akamaihd.net/economy/image/'+ e['itemImage']+'/85fx70f" alt="image" /></td>'
+'<td class="col-add"></td>'
+'</tr>';return itemsHtml;},remove:function remove(){this.stopListening();if(app.debug)console.log('mainPageView fully removed');}});app.AboutPageView=Backbone.View.extend({el:'div.content-main-inner',initialize:function initialize(options){if(app.locale==='ru'){this.template=_.template($('#about-ru').html());}else{this.template=_.template($('#about-en').html());}},render:function render(){this.$el.html(this.template({}));return this;},remove:function remove(){return this;}});app.HistoryPageView=Backbone.View.extend({el:'div.content-main-inner',initialize:function initialize(options){this.template=_.template($('#history-page').html());this.itemTemplate=_.template($('#history-item').html());},render:function render(){if(app.debug)console.log('HistoryPageView render call');this.$el.html(this.template({poly:app.poly}));if(this.model.get('games').length===0||this.model.get('lastUpdated')<_.now()- 10000){this.model.set({games:[],lastUpdated:_.now()},{silent:true});app.socket.emit('history-request',{all:true,page:1});this.listenToOnce(this.model,'change',this.renderItems);}else{this.renderItems();}
return this;},renderItems:function renderItems(){var html='';_.each(this.model.get('games'),function(e){html+=this.itemTemplate({game:e,poly:app.poly,locale:app.locale,filter:app.filter});},this);this.$('.history-wrap').html(html);_.delay(prizeDrop,300);return this;},remove:function remove(){this.stopListening();return this;}});app.SettingsPageView=Backbone.View.extend({el:'div.content-main-inner',events:{'click .fieldset-profile .btn-yellow':'saveSettings'},initialize:function initialize(options){this.template=_.template($('#settings').html());this.model=options.authModel;},render:function render(){var tokenLink='';if(this.model.get('token')!=null&&this.model.get('steamid_3')!=null){tokenLink='https://steamcommunity.com/tradeoffer/new/?partner='+ this.model.get('steamid_3')+'&token='+ this.model.get('token')}
this.$el.html(this.template({authModel:this.model.attributes,link:tokenLink,poly:app.poly}));this.delegateEvents();return this;},saveSettings:_.throttle(function saveSettings(){var link=this.$('#par2').val();app.socket.emit('token-link',{link:link});},1500,{trailing:false}),remove:function remove(){this.undelegateEvents();return this;}});app.LadderPageView=Backbone.View.extend({el:'div.content-main-inner',initialize:function initialize(options){this.gameStatsModel=options.gameStatsModel;this.template=_.template($('#ladder').html());this.itemTemplate=_.template($('#ladder-content').html());},render:function render(){if(app.debug)console.log('LadderPageView render call');this.$el.html(this.template({poly:app.poly}));if(this.model.get('top').length===0||this.model.get('lastUpdated')<_.now()- 15000){this.model.set({top:[],registered:55211,personal:{},lastUpdated:_.now()},{silent:true});app.socket.emit('ladder-request',{all:true,page:1});this.listenToOnce(this.model,'change',this.renderContents);}else{this.renderContents();}
return this;},renderContents:function renderContents(){console.dir(this.model.attributes)
var html=this.itemTemplate({stats:this.gameStatsModel.attributes,top:this.model.attributes,poly:app.poly,filter:app.filter});this.$('.ladder').html(html);},remove:function remove(){this.stopListening();return this;}});